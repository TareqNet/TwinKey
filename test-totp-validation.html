<!DOCTYPE html>
<html>
<head>
    <title>TwinKey TOTP Validation Test</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-result { margin: 10px 0; padding: 10px; border-radius: 5px; }
        .pass { background-color: #d4edda; color: #155724; }
        .fail { background-color: #f8d7da; color: #721c24; }
        .info { background-color: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <h1>Twin Key TOTP Validation Test</h1>
    <div id="results"></div>
    
    <script src="js/totp.js"></script>
    <script>
        async function runValidationTests() {
            const results = document.getElementById('results');
            
            // Test 1: RFC 6238 Test Vectors
            results.innerHTML += '<h2>RFC 6238 Test Vectors</h2>';
            
            const generator = new TOTPGenerator();
            const testCases = [
                { secret: 'GEZDGNBVGY3TQOJQGEZDGNBVGY3TQOJQ', time: 1111111109, expected: '081804' },
                { secret: 'GEZDGNBVGY3TQOJQGEZDGNBVGY3TQOJQ', time: 1234567890, expected: '005924' },
                { secret: 'GEZDGNBVGY3TQOJQGEZDGNBVGY3TQOJQ', time: 2000000000, expected: '279037' }
            ];
            
            for (const test of testCases) {
                try {
                    const result = await generator.generate(test.secret, test.time);
                    const pass = result === test.expected;
                    
                    results.innerHTML += `
                        <div class="test-result ${pass ? 'pass' : 'fail'}">
                            Time: ${test.time} | Expected: ${test.expected} | Got: ${result} ${pass ? '✓' : '✗'}
                        </div>
                    `;
                } catch (error) {
                    results.innerHTML += `
                        <div class="test-result fail">
                            Error testing ${test.time}: ${error.message}
                        </div>
                    `;
                }
            }
            
            // Test 2: Base32 Decoding
            results.innerHTML += '<h2>Base32 Decoding Tests</h2>';
            
            const base32Tests = [
                { input: 'JBSWY3DPEHPK3PXP', expected: 'Hello' },
                { input: 'GEZDGNBVGY3TQOJQ', expected: '12345678901234567890' }
            ];
            
            for (const test of base32Tests) {
                try {
                    const decoded = generator.base32Decode(test.input);
                    const text = new TextDecoder().decode(decoded);
                    const pass = text.includes(test.expected.substring(0, 4)); // Partial match
                    
                    results.innerHTML += `
                        <div class="test-result ${pass ? 'pass' : 'info'}">
                            Input: ${test.input} | Decoded length: ${decoded.length} bytes ${pass ? '✓' : ''}
                        </div>
                    `;
                } catch (error) {
                    results.innerHTML += `
                        <div class="test-result fail">
                            Error decoding ${test.input}: ${error.message}
                        </div>
                    `;
                }
            }
            
            // Test 3: Timing Functions
            results.innerHTML += '<h2>Timing Functions Tests</h2>';
            
            const timeLeft = generator.getRemainingSeconds();
            const progress = generator.getProgress();
            
            results.innerHTML += `
                <div class="test-result info">
                    Remaining seconds: ${timeLeft} (valid: ${timeLeft >= 0 && timeLeft <= 30 ? '✓' : '✗'})
                </div>
                <div class="test-result info">
                    Progress: ${progress.toFixed(2)}% (valid: ${progress >= 0 && progress <= 100 ? '✓' : '✗'})
                </div>
            `;
            
            // Test 4: Secret Validation
            results.innerHTML += '<h2>Secret Validation Tests</h2>';
            
            const validationTests = [
                { secret: 'JBSWY3DPEHPK3PXP', shouldBeValid: true },
                { secret: 'invalidkey123', shouldBeValid: false },
                { secret: 'SHORT', shouldBeValid: false },
                { secret: 'GEZDGNBVGY3TQOJQGEZDGNBVGY3TQOJQ', shouldBeValid: true }
            ];
            
            for (const test of validationTests) {
                const isValid = generator.validateSecret(test.secret);
                const pass = isValid === test.shouldBeValid;
                
                results.innerHTML += `
                    <div class="test-result ${pass ? 'pass' : 'fail'}">
                        Secret: ${test.secret} | Expected: ${test.shouldBeValid} | Got: ${isValid} ${pass ? '✓' : '✗'}
                    </div>
                `;
            }
            
            // Test 5: Current Time Generation
            results.innerHTML += '<h2>Current Time Generation Test</h2>';
            
            try {
                const currentOTP = await generator.generate('JBSWY3DPEHPK3PXP');
                const isValidFormat = /^\d{6}$/.test(currentOTP);
                
                results.innerHTML += `
                    <div class="test-result ${isValidFormat ? 'pass' : 'fail'}">
                        Current OTP: ${currentOTP} | Format valid: ${isValidFormat ? '✓' : '✗'}
                    </div>
                `;
                
                // Test with spaces in secret
                const secretWithSpaces = 'JBSW Y3DP EHPK 3PXP';
                const otpWithSpaces = await generator.generate(secretWithSpaces);
                const sameResult = currentOTP === otpWithSpaces;
                
                results.innerHTML += `
                    <div class="test-result ${sameResult ? 'pass' : 'fail'}">
                        Secret with spaces handling: ${sameResult ? '✓' : '✗'}
                    </div>
                `;
                
            } catch (error) {
                results.innerHTML += `
                    <div class="test-result fail">
                        Error generating current OTP: ${error.message}
                    </div>
                `;
            }
        }
        
        // Run tests when page loads
        window.onload = runValidationTests;
    </script>
</body>
</html>